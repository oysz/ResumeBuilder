# 更新机制与版本控制文档

本文档说明 ResumeBuilder 项目的自动更新机制和版本发布流程。

## 📋 目录

- [更新机制概述](#更新机制概述)
- [开发者发布流程](#开发者发布流程)
- [版本号管理规范](#版本号管理规范)
- [用户更新体验](#用户更新体验)
- [技术实现细节](#技术实现细节)
- [代码签名说明](#代码签名说明)
- [常见问题 FAQ](#常见问题-faq)
- [故障排查](#故障排查)
- [更新日志](#更新日志)

---

## 更新机制概述

本项目使用 **electron-updater** 实现自动更新功能，通过 GitHub Releases 作为更新服务器。

### 核心特性

- ✅ **自动检测更新**：应用启动后自动检查新版本
- ✅ **手动检查**：用户可通过菜单手动触发更新检查
- ✅ **实时进度显示**：下载时显示进度条和百分比
- ✅ **多平台支持**：Windows、macOS、Linux 各自独立更新
- ✅ **增量更新**：支持差分更新，减少下载流量

### 更新流程图

```
用户启动应用
    ↓
3秒后自动检查更新（或用户手动检查）
    ↓
向 GitHub Releases 查询最新版本
    ↓
发现新版本？
    ├─ macOS → 对话框提示 → [手动下载] 或 [尝试自动更新]
    ├─ Windows → 对话框提示 → [自动更新] [手动下载] [稍后提醒]
    └─ Linux → 自动显示更新对话框
    ↓
选择"自动更新" → 显示更新对话框
    ↓
点击"立即更新" → 开始下载
    ↓
📊 实时显示下载进度（进度条 + 百分比 + 大小）
    ↓
下载完成 → 显示"重启并安装"按钮
    ↓
重启应用 → 安装更新
    ↓
完成！
```

---

## 开发者发布流程

### 快速发布（3步走）

#### 方式一：仅发布 macOS 版本

```bash
# 1️⃣ 修改版本号
# 编辑 package.json
{
  "version": "1.0.2"  # 从旧版本升级
}

# 2️⃣ 运行构建命令
npm run electron:build:mac

# ✅ 3️⃣ 完成！自动发布到 GitHub
```

#### 方式二：发布所有平台

```bash
# 1️⃣ 修改版本号后
npm run electron:build

# ✅ 完成！自动发布 Windows、macOS、Linux 版本
```

### 完整发布流程（含代码签名）

对于 macOS 应用，由于没有 Apple Developer 证书，需要手动签名：

```bash
# 1️⃣ 修改版本号
vim package.json  # 修改 version 字段

# 2️⃣ 构建应用
npm run electron:build:mac

# 3️⃣ 手动签名（macOS）
./scripts/sign-mac-app.sh "release/mac-arm64/简历生成器.app"

# 4️⃣ 重新打包
cd release/mac-arm64
rm -f ../../resume-builder-1.0.0-arm64.zip
zip -r -y -q ../../resume-builder-1.0.0-arm64.zip "简历生成器.app"
cd ../..

# 5️⃣ 重新生成 blockmap
npx electron-builder --mac --publish never

# 6️⃣ 上传到 GitHub
gh release upload v1.0.0 \
  resume-builder-1.0.0-arm64.zip \
  release/resume-builder-1.0.0-arm64.zip.blockmap \
  release/latest-mac.yml \
  --repo oysz/ResumeBuilder --clobber
```

### 自动化功能

运行构建命令后，**electron-builder** 会自动完成以下操作：

1. ✅ 构建 macOS 应用（DMG + ZIP 格式）
2. ✅ 生成增量更新文件（blockmap）
3. ✅ 创建 Git Tag（如 `v1.0.2`）
4. ✅ 创建/更新 GitHub Release
5. ✅ 上传所有必要文件到 Release：
   - `resume-builder-{version}.dmg`
   - `resume-builder-{version}.dmg.blockmap`
   - `resume-builder-{version}-arm64.zip`
   - `resume-builder-{version}-arm64.zip.blockmap`
   - `latest-mac.yml`（更新配置文件）

### 环境要求

首次发布前需要配置 GitHub Token：

```bash
# 1. 生成 GitHub Personal Access Token
# 访问：https://github.com/settings/tokens
# 权限勾选：repo

# 2. 设置环境变量
export GH_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxx"

# 3. 永久保存（可选）
echo 'export GH_TOKEN="你的token"' >> ~/.zshrc
source ~/.zshrc
```

---

## 版本号管理规范

遵循 [语义化版本](https://semver.org/lang/zh-CN/) 规范：

### 版本号格式

```
主版本号.次版本号.修订号 (MAJOR.MINOR.PATCH)
例如：1.0.2
```

### 版本号规则

| 变更类型 | 版本号示例 | 说明 | 示例 |
|---------|-----------|------|------|
| **修订版 (PATCH)** | `1.0.0` → `1.0.1` | 向下兼容的问题修复 | 修复 bug、性能优化 |
| **次版本 (MINOR)** | `1.0.0` → `1.1.0` | 向下兼容的功能性新增 | 新增功能特性 |
| **主版本 (MAJOR)** | `1.0.0` → `2.0.0` | 可能的向下不兼容变更 | 架构重构、重大变更 |

### 版本号示例

```json
// package.json
{
  "version": "1.0.0"  // 初始发布
  "version": "1.0.1"  // 修复了一个 bug
  "version": "1.0.2"  // 改进了更新提示和进度显示
  "version": "1.1.0"  // 新增了导出图片功能
  "version": "2.0.0"  // 全新设计的 UI 架构
}
```

### 发布频率建议

- **修订版 (PATCH)**：随时可以发布，用于快速修复 bug
- **次版本 (MINOR)**：积累 3-5 个新功能后发布
- **主版本 (MAJOR)**：重大变更或重构时发布，需充分测试

---

## 用户更新体验

### 各平台更新体验对比

| 平台 | 检测到更新时 | 下载体验 | 安装体验 | 代码签名 |
|------|------------|---------|---------|---------|
| **macOS** | 弹出对话框，推荐手动下载 | 显示进度条（可选） | 手动拖拽安装 | Ad-hoc 签名 |
| **Windows** | 弹出对话框，3 个选项 | ✅ 显示进度条 | 自动安装（有安全警告） | 无签名 |
| **Linux** | 自动显示对话框 | ✅ 显示进度条 | ✅ 自动安装 | 无需签名 |

### macOS 更新流程

**1. 检测到更新时：**
```
发现新版本 1.0.2

当前版本：1.0.0

由于 macOS 的安全机制，建议您手动下载新版本：

1. 点击"前往下载"打开下载页面
2. 下载最新的 .dmg 文件
3. 拖拽到 Applications 文件夹

[前往下载] [稍后提醒] [尝试自动更新（可能失败）]
```

**2. 选择"尝试自动更新"：**
- 显示前端更新对话框
- 显示新版本信息和下载进度
- 下载完成后提示重启安装

**3. 选择"前往下载"：**
- 自动打开 GitHub Releases 页面
- 手动下载并安装

### Windows 更新流程

**1. 检测到更新时：**
```
发现新版本 1.0.2

当前版本：1.0.0

您可以：

1. 自动更新（推荐）：程序会自动下载并安装更新
   注意：可能会看到 Windows Defender 的安全警告，
   点击"更多信息" → "仍要运行" 即可

2. 手动下载：前往 GitHub 下载最新版本

[自动更新] [手动下载] [稍后提醒]
```

**2. 选择"自动更新"：**
- 显示更新对话框
- 开始下载时显示实时进度
- 下载完成后自动安装并重启

**3. 安装过程：**
- 可能看到 Windows Defender 警告
- 点击"更多信息" → "仍要运行"
- 自动完成安装

### Linux 更新流程

- 自动检测更新
- 显示更新对话框
- 自动下载并安装
- 无需代码签名，体验最佳

### 更新对话框 UI

下载时会显示：

```
┌─────────────────────────────┐
│       应用更新               │
├─────────────────────────────┤
│                             │
│         [旋转图标]           │
│          45%                │
│                             │
│     正在下载更新...          │
│                             │
│  下载进度         45%       │
│  [████████░░░░░░░]          │
│  已下载: 45 MB / 100 MB     │
│                             │
├─────────────────────────────│
│      [ 下载中... ]          │
└─────────────────────────────┘
```

---

## 技术实现细节

### 项目配置

#### 1. package.json 配置

```json
{
  "version": "1.0.0",
  "build": {
    "appId": "com.resumebuilder.app",
    "productName": "简历生成器",
    "publish": {
      "provider": "github",
      "owner": "oysz",
      "repo": "ResumeBuilder",
      "releaseType": "release",
      "vPrefixedTagName": true
    },
    "mac": {
      "target": ["dmg", "zip"],
      "icon": "build/icon.icns",
      "category": "public.app-category.productivity",
      "artifactName": "resume-builder-${version}-${arch}.${ext}"
    }
  }
}
```

**关键配置说明：**
- `provider: github`: 使用 GitHub 作为更新服务器
- `releaseType: release`: 标记为正式发布版本（非预发布）
- `vPrefixedTagName: true`: 使用带 `v` 前缀的标签（如 `v1.0.0`）
- `artifactName`: 统一使用英文文件名，避免中文路径问题

#### 2. electron/main.js 配置

```javascript
const { autoUpdater } = require('electron-updater')

function configureAutoUpdater() {
  // 配置更新源
  autoUpdater.setFeedURL({
    provider: 'github',
    owner: 'oysz',
    repo: 'ResumeBuilder'
  })

  autoUpdater.logger = log
  autoUpdater.logger.transports.file.level = 'info'

  // 不自动下载，让用户确认
  autoUpdater.autoDownload = false

  // 添加请求头
  autoUpdater.requestHeaders = {
    'Accept': 'application/json, text/plain, */*'
  }

  // 监听更新事件
  autoUpdater.on('update-available', (info) => {
    // 根据平台显示不同的对话框
    if (process.platform === 'darwin') {
      // macOS：推荐手动下载
      dialog.showMessageBox(...)
    } else if (process.platform === 'win32') {
      // Windows：说明安全警告后让用户选择
      dialog.showMessageBox(...)
    } else {
      // Linux：直接自动更新
      mainWindow?.webContents.send('update-available', info)
    }
  })

  autoUpdater.on('download-progress', (progress) => {
    // 发送下载进度到前端
    mainWindow?.webContents.send('update-status', {
      status: 'downloading',
      message: '正在下载更新...',
      progress: {
        percent: Math.floor(progress.percent),
        transferred: Math.floor(progress.transferred / 1024 / 1024),
        total: Math.floor(progress.total / 1024 / 1024)
      }
    })
  })
}
```

#### 3. 前端监听更新状态

```typescript
// src/components/Update/UpdateDialog.tsx
useEffect(() => {
  if (!window.electronAPI?.onUpdateStatus) return

  const cleanup = window.electronAPI.onUpdateStatus((data: UpdateStatusData) => {
    // 根据状态更新 UI
    if (data.status === 'downloading') {
      setUpdateStatus({
        visible: true,
        status: data.status,
        message: data.message,
        downloadProgress: data.progress,
      })
    }
  })

  return cleanup
}, [setUpdateStatus])
```

### 更新文件说明

#### latest-mac.yml

```yaml
version: 1.0.0
files:
  - url: resume-builder-1.0.0-arm64.zip
    sha512: rFCp646kPFnJn0iqAe5yor5FJddMImEqkxcjrCdknOKD9MnsHatS5HvtcHSOH3L3vdNAvE3CdWpGgpxeuwJRrQ==
    size: 98930829
  - url: resume-builder-1.0.0.dmg
    sha512: H4or2o9mytx3bDspNkKBolM+B6HoPFNVv4t8kiJGGwAM/wNTa4t46qfmb+ZLIogJsnfG9EYVgdIZ3p28VDEJqw==
    size: 102570461
path: resume-builder-1.0.0-arm64.zip
sha512: rFCp646kPFnJn0iqAe5yor5FJddMImEqkxcjrCdknOKD9MnsHatS5HvtcHSOH3L3vdNAvE3CdWpGgpxeuwJRrQ==
releaseDate: '2026-01-17T14:44:25.365Z'
```

**作用：** 告诉 electron-updater 最新的版本信息和下载地址

#### app-update.yml

```yaml
owner: oysz
repo: ResumeBuilder
provider: github
releaseType: release
vPrefixedTagName: true
updaterCacheDirName: resume-builder-updater
```

**作用：** 应用内置的配置，告诉 electron-updater 从哪里获取更新

---

## 代码签名说明

### 为什么需要代码签名？

代码签名用于验证应用的来源和完整性：

- **macOS**: Gatekeeper 会检查签名，未签名或签名不当的应用会被阻止
- **Windows**: SmartScreen 会警告用户未签名的应用
- **Linux**: 通常不需要代码签名

### 当前方案（Ad-hoc 签名）

我们使用 **ad-hoc 签名**（临时签名）：

**优点：**
- ✅ 免费，无需 Apple Developer 证书
- ✅ 可以在本地运行和测试
- ✅ 用户可以右键打开运行

**缺点：**
- ❌ macOS 会提示"来自身份不明开发者"
- ❌ 自动更新可能失败
- ❌ 用户需要手动确认安全性

### 签名脚本

我们提供了自动签名脚本：

```bash
#!/bin/bash
# scripts/sign-mac-app.sh

APP_PATH="$1"

# 移除所有现有签名
codesign --remove-signature "$APP_PATH" 2>/dev/null || true

# 为所有 Helper 应用签名
find "$APP_PATH/Contents/Frameworks" -name "*.app" -type d | while read helper; do
  codesign --force --deep --sign - "$helper" 2>/dev/null || true
done

# 为所有 Frameworks 签名
find "$APP_PATH/Contents/Frameworks" -name "*.framework" -type d | while read framework; do
  codesign --force --deep --sign - "$framework" 2>/dev/null || true
done

# 为主应用签名
codesign --force --deep --sign - "$APP_PATH"
```

**使用方法：**
```bash
./scripts/sign-mac-app.sh "release/mac-arm64/简历生成器.app"
```

### 生产环境方案（推荐）

如果要公开发布应用，建议申请 **Apple Developer 证书**：

#### 1. 加入 Apple Developer Program

- **费用**: $99/年
- **申请地址**: https://developer.apple.com/programs/

#### 2. 获取证书

```bash
# 下载证书后，导入到钥匙串
# 证书名称示例：Developer ID Application: Your Name (TEAM_ID)
```

#### 3. 配置 package.json

```json
{
  "build": {
    "mac": {
      "identity": "Developer ID Application: Your Name (TEAM_ID)",
      "hardenedRuntime": true,
      "gatekeeperAssess": false
    }
  }
}
```

#### 4. 验证签名

```bash
# 验证应用签名
codesign -dv "你的应用.app"

# 验证详细信息
codesign -dvv "你的应用.app"
```

### Windows 代码签名

如果需要为 Windows 应用签名：

#### 1. 购买代码签名证书

- **DigiCert**（推荐）：$474/年
- **Sectigo**: $178-395/年

#### 2. 配置签名

```bash
# 设置环境变量
export CSC_LINK="path/to/certificate.pfx"
export CSC_KEY_PASSWORD="your-password"

# 或在 package.json 中配置
{
  "build": {
    "win": {
      "certificateFile": "path/to/certificate.pfx",
      "certificatePassword": "your-password"
    }
  }
}
```

---

## 常见问题 FAQ

### Q1: macOS 更新时提示"代码不含资源"错误？

**原因：** 代码签名不完整或签名验证失败。

**解决方案：**
1. 使用签名脚本完整签名所有组件
2. 重新打包并上传
3. 用户选择"手动下载"安装

```bash
./scripts/sign-mac-app.sh "release/mac-arm64/简历生成器.app"
```

### Q2: Windows 更新时看到 SmartScreen 警告？

**原因：** 应用没有代码签名。

**解决方案：**
1. 点击"更多信息" → "仍要运行"
2. 或购买代码签名证书（~$200/年）

### Q3: 用户无法收到更新通知？

**可能原因：**
1. GitHub Token 配置错误或过期
2. Release 标记为 `prerelease: true`
3. `latest-mac.yml` 文件未上传到 Release
4. 版本号未更新（仍为旧版本）

**解决方案：**
```bash
# 检查 Release 状态
gh release view v1.0.0 --repo oysz/ResumeBuilder

# 确认 isPrerelease 为 false
# 确认 latest-mac.yml 文件存在
```

### Q4: 如何测试更新功能？

**步骤：**
1. 发布新版本（如 1.0.2）到 GitHub
2. 将本地 `package.json` 版本改回旧版本（1.0.0）
3. 重新构建应用
4. 运行应用并检查更新
5. 应该提示发现新版本 1.0.2

### Q5: 如何回退已发布的版本？

**不推荐回退**，正确做法是：
1. 发布新的修订版修复问题（如 1.0.0 → 1.0.1）
2. 如需删除旧 Release：
```bash
gh release delete v1.0.0 --repo oysz/ResumeBuilder --yes
git tag -d v1.0.0
git push origin :refs/tags/v1.0.0
```

### Q6: 支持增量更新（差分更新）吗？

**支持！** electron-builder 默认支持增量更新：
- 首次发布：生成完整安装包 + blockmap 文件
- 后续更新：只下载变更部分（通过 blockmap 计算）
- 自动处理：无需额外配置

### Q7: 如何禁用自动更新？

**临时禁用：**
```javascript
// electron/main.js
autoUpdater.autoDownload = false  // 不自动下载
```

**永久禁用：**
删除 `electron/main.js` 中的更新相关代码

### Q8: 多平台发布的文件在哪里？

| 平台 | 输出目录 | 文件格式 |
|-----|---------|---------|
| macOS | `release/mac-arm64/` | `.app`, `.dmg`, `.zip` |
| Windows | `release/win-unpacked/` | `.exe`, `.zip` |
| Linux | `release/linux-arm64-unpacked/` | `.AppImage`, `.deb`, `.rpm` |

### Q9: 下载进度不显示怎么办？

**检查：**
1. 确认前端正确监听 `update-status` 事件
2. 查看浏览器控制台是否有错误
3. 检查 `autoUpdater.on('download-progress')` 是否正确发送数据

### Q10: macOS 更新对话框不显示？

**原因：** macOS 默认显示原生对话框，不显示前端对话框。

**解决方案：**
- 在 macOS 对话框中选择"尝试自动更新"
- 或修改代码，让 macOS 也直接显示前端对话框

---

## 故障排查

### 问题 1：检查更新无响应

**检查步骤：**
```bash
# 1. 检查网络连接
curl -I https://github.com/oysz/ResumeBuilder/releases/latest

# 2. 检查 GitHub API
curl https://api.github.com/repos/oysz/ResumeBuilder/releases/latest

# 3. 查看应用日志
~/Library/Logs/简历生成器/main.log
```

### 问题 2：下载更新失败

**可能原因：**
- 网络连接问题
- GitHub Release 文件损坏
- 磁盘空间不足

**解决方案：**
```bash
# 重新上传文件到 Release
gh release upload v1.0.1 release/*.dmg --repo oysz/ResumeBuilder --clobber
```

### 问题 3：更新后应用无法启动

**解决方案：**
1. 检查代码是否有破坏性变更
2. 回退到旧版本并修复问题
3. 发布新的修订版

### 问题 4：构建失败

**常见错误：**
```
Error: Cannot find module 'electron-builder'
```

**解决方案：**
```bash
npm install
npm install electron-builder --save-dev
```

### 问题 5：签名失败

**错误信息：**
```
code object is not signed at all
```

**解决方案：**
```bash
# 使用完整签名脚本
./scripts/sign-mac-app.sh "path/to/app.app"

# 或手动签名所有组件
find "path/to/app.app/Contents" -name "*.app" -exec codesign --force --deep --sign - {} \;
```

---

## 最佳实践

### 1. 版本发布检查清单

- [ ] 修改 `package.json` 版本号
- [ ] 更新 CHANGELOG.md（如有）
- [ ] 本地测试应用功能正常
- [ ] macOS：运行签名脚本
- [ ] 运行构建命令
- [ ] 验证 GitHub Release 创建成功
- [ ] 验证所有文件上传成功
- [ ] 下载并测试新版本
- [ ] 通知用户更新（可选）

### 2. 测试更新流程

```bash
# 1. 发布新版本
npm version patch  # 自动升级版本号 (1.0.0 -> 1.0.1)
npm run electron:build:mac

# 2. 本地回退版本测试
git checkout v1.0.0
npm run build && npx electron-builder --mac

# 3. 运行旧版本测试更新
open release/mac-arm64/简历生成器.app
# 点击"帮助" → "检查更新"
```

### 3. 发布频率建议

- **紧急修复**: 立即发布修订版（PATCH）
- **功能更新**: 每 2-4 周发布次版本（MINOR）
- **重大更新**: 每 3-6 个月发布主版本（MAJOR）

---

## 相关资源

- [electron-updater 官方文档](https://www.electron.build/auto-update)
- [electron-builder 文档](https://www.electron.builder/)
- [语义化版本规范](https://semver.org/lang/zh-CN/)
- [GitHub Releases API](https://docs.github.com/en/rest/releases/releases)
- [Apple Developer Program](https://developer.apple.com/programs/)
- [macOS 代码签名指南](https://developer.apple.com/support/code-signing/)

---

## 更新日志

### v1.0.2 (2026-01-18)

**新增功能：**
- ✨ 添加 Windows 平台友好的更新提示对话框
- ✨ 添加实时下载进度显示（进度条 + 百分比 + 大小）
- ✨ 改进各平台更新体验的一致性

**技术改进：**
- 🔧 统一使用 Electron IPC 事件监听
- 🔧 改进 macOS 签名流程
- 🔧 优化更新对话框 UI

**文档更新：**
- 📝 完整更新代码签名说明
- 📝 添加各平台更新体验对比
- 📝 扩展故障排查指南

### v1.0.1 (2026-01-17)

- 🎉 初始版本发布
- ✅ 基础自动更新功能

---

**文档维护者：** oysz
**最后更新：** 2026-01-18
